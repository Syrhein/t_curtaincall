<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>게시글 작성</title>
  <link rel="stylesheet" href="./css/BoardWrite.css">
  <script src="./js/navigation.js"></script>
</head>
<body>

<!-- ✅ 헤더 -->
<div class="header">
  <div class="Frame1">
    <div class="categories">
      <div class="category">국내창작</div>
      <div class="category">라이센스</div>
      <div class="category">게시판</div>
    </div>
    <div class="logo">CURTAIN CALL GUIDE</div>
    <div class="Buttons">
      <div class="BtnSignUp"><div class="SignUp">회원가입</div></div>
      <div class="BtnLogin"><div class="Login">로그인</div></div>
      <div class="BtnLogout" style="display: none;"><div class="Logout">로그아웃</div></div>
      <img src="./img/icon_my.png" class="icon_my" alt="My Icon">
    </div>
  </div>
</div>

<!-- ✅ 게시글 작성 폼 -->
<div class="container">
  <h1 id="pageTitle">게시글 작성</h1>
  <form id="postForm" enctype="multipart/form-data">
    <input type="text" id="postTitle" name="postTitle" placeholder="제목을 입력하세요" required><br><br>
    <textarea id="postContent" name="postContent" rows="10" placeholder="내용을 입력하세요" required></textarea><br><br>
    <input type="file" id="postFile" name="postFile"><br><br>
    <button type="submit" id="submitPost">등록</button>
    <button type="button" onclick="location.href='board.html'">취소</button>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("postForm");
  const urlParams = new URLSearchParams(location.search);
  const mode = urlParams.get("mode"); // 'edit' or null
  const postIdx = urlParams.get("postIdx");

  if (mode === "edit" && postIdx) {
    document.getElementById("pageTitle").innerText = "게시글 수정";
    document.getElementById("submitPost").innerText = "수정";

    // 기존 게시글 정보 불러오기
    fetch(`/api/posts/${postIdx}`)
      .then(res => res.json())
      .then(post => {
        document.getElementById("postTitle").value = post.postTitle;
        document.getElementById("postContent").value = post.postContent;
      })
      .catch(err => console.error("게시글 불러오기 실패:", err));
  }

  // 폼 제출
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);

    let endpoint = "/api/posts";
    let method = "POST";

    if (mode === "edit" && postIdx) {
      endpoint = `/api/posts/${postIdx}`;
      method = "PUT";
    }

    try {
      const response = await fetch(endpoint, {
        method,
        body: formData
      });

      const result = await response.json();
      if (result.success) {
        alert(mode === "edit" ? "게시글이 수정되었습니다." : "게시글이 등록되었습니다.");
        location.href = "board.html";
      } else {
        alert("작업 실패: " + (result.error || "알 수 없는 오류"));
      }
    } catch (err) {
      console.error("게시글 처리 실패:", err);
      alert("서버 오류 발생");
    }
  });
});
</script>

<script src="./js/common.js"></script>
</body>
</html>
