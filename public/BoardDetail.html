<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>게시글 상세보기</title>
  <link rel="stylesheet" href="./css/BoardDetail.css">
  <script src="./js/navigation.js"></script>
</head>
<body>

<!-- ✅ 헤더 -->
<div class="header">
  <div class="Frame1">
    <div class="categories">
      <div class="category">국내창작</div>
      <div class="category">라이센스</div>
      <div class="category">게시판</div>
    </div>
    <div class="logo">CURTAIN CALL GUIDE</div>
    <div class="Buttons">
      <div class="BtnSignUp"><div class="SignUp">회원가입</div></div>
      <div class="BtnLogin"><div class="Login">로그인</div></div>
      <div class="BtnLogout" style="display: none;"><div class="Logout">로그아웃</div></div>
      <img src="./img/icon_my.png" class="icon_my" alt="My Icon">
    </div>
  </div>
</div>

<!-- ✅ 게시글 상세 영역 -->
<div class="container">
  <div class="card-view">

    <!-- 제목 -->
    <h2 class="title" id="postTitle">제목 불러오는 중...</h2>

    <!-- 작성자, 날짜, 조회수 -->
    <div class="myinfo">
      <dl>
        <dt>작성자</dt>
        <dd id="postAuthor">-</dd>
        <dt>작성일</dt>
        <dd id="postDate">-</dd>
        <dt>조회수</dt>
        <dd id="postViews">0</dd>
      </dl>
    </div>

    <div class="space"></div>

    <!-- 게시글 내용 -->
    <div class="cont">
      <div class="cont_text" id="postContent">내용 불러오는 중...</div>
    </div>

    <!-- 첨부파일 -->
    <div id="fileDownloadSection" class="card-header" style="margin-top: 20px;"></div>

    <!-- 수정/삭제/목록 버튼 -->
    <div id="postButtons" class="btn-view">
      <a href="#" onclick="goToEdit()">수정</a>
      <a href="#" onclick="deletePost()">삭제</a>
      <a href="board.html">목록</a>
    </div>

	 <!-- ✅ 댓글 영역: container 안쪽으로 이동 -->
	 <div class="comment-wrapper">
		<h3 class="comment-title">댓글</h3>
		<div id="comment-list" class="comment-list"></div>
		<div class="comment-form">
		  <textarea id="comment-content" class="comment-input" placeholder="댓글을 입력하세요."></textarea>
		  <button id="comment-submit" class="comment-submit-btn">작성</button>
	</div>

  </div>
</div>


<script>
let postData = null;
let loginUserId = null;

document.addEventListener("DOMContentLoaded", async () => {
  const urlParams = new URLSearchParams(location.search);
  const postIdx = urlParams.get("postIdx");
  loadComments(); // 댓글 불러오기 추가
  if (!postIdx) {
    alert("게시글 정보를 확인할 수 없습니다.");
    location.href = "board.html";
    return;
  }

  try {
    // 로그인 사용자 확인
    const loginRes = await fetch('/api/login/status', { credentials: 'include' });
    const loginData = await loginRes.json();
    if (loginData.loggedIn) {
      loginUserId = loginData.user.id;
    }

    // 게시글 데이터 불러오기
    const postRes = await fetch(`/api/posts/${postIdx}`);
    postData = await postRes.json();

    document.getElementById("postTitle").innerText = postData.postTitle;
    document.getElementById("postAuthor").innerText = postData.userName || postData.userId;
    document.getElementById("postDate").innerText = new Date(postData.createdAt).toLocaleDateString();
    document.getElementById("postViews").innerText = postData.postViews;
    document.getElementById("postContent").innerHTML = postData.postContent.replace(/\n/g, "<br>");

    if (postData.postFileName && postData.postFilePath) {
      const filePath = postData.postFilePath.startsWith('/uploads') ? postData.postFilePath : `/uploads/${postData.postFilePath}`;
      document.getElementById("fileDownloadSection").innerHTML = `
        <h3><a href="${filePath}" download="${postData.postFileName}">${postData.postFileName}</a></h3>
      `;
    }

    // 본인 글이 아닐 경우 버튼 숨기기
    if (!loginUserId || loginUserId !== postData.userId) {
      document.getElementById("postButtons").style.display = "none";
    }

  } catch (err) {
    alert("게시글을 불러오는 중 오류가 발생했습니다.");
    console.error(err);
  }
});

function goToEdit() {
  const postIdx = new URLSearchParams(location.search).get("postIdx");
  location.href = `board_write.html?mode=edit&postIdx=${postIdx}`;
}

function deletePost() {
  const postIdx = new URLSearchParams(location.search).get("postIdx");
  if (!confirm("정말로 이 글을 삭제하시겠습니까?")) return;

  fetch(`/api/posts/${postIdx}`, {
    method: "DELETE"
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      alert("삭제되었습니다.");
      location.href = "board.html";
    } else {
      alert("삭제 실패: " + result.error);
    }
  })
  .catch(error => {
    alert("삭제 중 오류 발생");
    console.error(error);
  });
}

// 댓글 불러오기
async function loadComments() {
  const postIdx = new URLSearchParams(location.search).get("postIdx");
  try {
    const res = await fetch(`/api/comments/${postIdx}`);
    const comments = await res.json();

    const list = document.getElementById("comment-list");
    list.innerHTML = ""; // 초기화

    if (comments.length === 0) {
      list.innerHTML = "<p>댓글이 없습니다.</p>";
      return;
    }

	comments.forEach(comment => {
		const commentEl = document.createElement("div");
		commentEl.classList.add("comment-item");

		const dateStr = new Date(comment.createdAt).toLocaleString();

		commentEl.innerHTML = `
			<div>
			<span class="comment-author">${comment.userName || comment.userId}</span>
			<span class="comment-date">${dateStr}</span>
			</div>
			<div class="comment-content">${comment.content}</div>
		`;

  list.appendChild(commentEl);
});


  } catch (err) {
    console.error("댓글 불러오기 오류:", err);
    document.getElementById("comment-list").innerHTML = "<p>댓글을 불러오지 못했습니다.</p>";
  }
}

// 댓글 작성
document.getElementById("comment-submit").addEventListener("click", async () => {
  const content = document.getElementById("comment-content").value.trim();
  const postIdx = new URLSearchParams(location.search).get("postIdx");

  if (!content) {
    alert("댓글 내용을 입력해주세요.");
    return;
  }

  try {
    const res = await fetch('/api/comments', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        postId: postIdx,
        userId: loginUserId,
        content
      })
    });

    const result = await res.json();

    if (res.ok) {
      document.getElementById("comment-content").value = "";
      loadComments();
    } else {
      alert("댓글 작성 실패: " + (result.error || "서버 오류"));
    }

  } catch (err) {
    console.error("댓글 작성 오류:", err);
    alert("댓글 작성 중 오류가 발생했습니다.");
  }
});


</script>

<script src="./js/common.js"></script>
</body>
</html>
